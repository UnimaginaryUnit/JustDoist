<html>
<head>
{% load staticfiles %}
<link type="text/css" rel="stylesheet" href="{% static 'css/materialize.css' %}"  media="screen,projection"/>
<link type="text/css" rel="stylesheet" href="{% static 'css/index.css' %}"  media="screen,projection"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>JustDoist</title>
<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="{% static 'js/materialize.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/colorscheme.js' %}"></script>
{% load staticfiles %}
<meta http-equiv="Cache-Control" content="no-cache">
<link rel="icon" href="{% static 'img/logo.png' %}">
</head>


<style id="style-color">
.stats-slider{
    position:absolute;
    bottom:0;
    left:0;
}
</style>
    
<body id="content">
    
<nav class="layout-color">
<div class="nav-wrapper layout-color">
{% load staticfiles %}
    <a href="" class="brand-logo left" style="font-weight: 600; margin-left: 1rem;">J
        <img id="logo_img" src="{% static 'img/logo_red.svg' %}"> stDoist</a>
   <ul class="right hide-on-med-and-down">
    <li><a href="/index"><i class="material-icons left">description</i>PROBLEMS</a></li>
    <li><a href="/profile/no_add" class="active"><i class="material-icons left">equalizer</i>PROGRESS</a></li>
    <li><a href="/settings"><i class="material-icons left">settings</i>SETTINGS</a></li>
    <li><a href="/contact_us"><i class="material-icons left">info_outline</i>CONTACT US</a></li>
    <li><a href="/logout"><i class="material-icons">exit_to_app</i></a></li>
  </ul>
  <ul class="right hide-on-large-only">
    <li><a href="/index"><i class="material-icons ">description</i></a></li>
    <li><a href="/profile/no_add" class="active"><i class="material-icons ">equalizer</i></a></li>
    <li><a href="/settings"><i class="material-icons">settings</i></a></li>
    <li><a href="/contact_us"><i class="material-icons ">info_outline</i></a></li>
    <li><a href="/logout"><i class="material-icons">exit_to_app</i></a></li>
  </ul>

</div>
</nav>

<!--  Main  -->
<div class="container" style="width:85%;"><div class="row">
    <div class="col s12">
        <h4>Progress</h4>
        {% if not probs %}
        <h4>You have no problems to work on yet.</h4>
        {% endif %}
    </div>
    
    {% for problem in probs %}
    <div class="col s4">
        <div class="card problem-card" onclick="open_problem_modal({{ problem.id }}, this)">
            <div class="card-content">
                <p >{{ problem.title }}</p>
                <span>{{ problem.percantage }}%</span>
                <div class="stats-slider">
                    <div data="{{ problem.percantage }}"></div>
                </div>
            </div>
        </div>
        
    </div>
    {% endfor %}
    
    
</div></div>
    
  
<div id="modal1" class="modal">
<div class="modal-content">
<h4>Modal Header</h4>
    
</div>
<div class="modal-footer">
<a href="#!" class="modal-action modal-close waves-effect waves-light red btn">OK</a>
</div>
</div>
    
</body>
     
<script>
$(document).ready(function(){
    drawcolor();
    $('.modal').modal({
        dismissible: true, // Modal can be dismissed by clicking outside of the modal
        startingTop: '0%', // Starting top style attribute
        endingTop: '0%' // Ending top style attribute
    });
    $('.tooltipped').tooltip({delay: 50});
    $('select').material_select();
    $(".dropdown-button").dropdown({hover:true});
    build_stats();
});
function build_stats(){
    slid = $('.stats-slider > div');
    for (i = 0; i < slid.length; i++){
        
        wid =  parseInt($(slid[i]).attr("data"));
        $(slid[i]).animate({
            "width": Math.abs(wid) + "%"
        }, 1000);
        $(slid[i]).css({
            "width" : Math.abs(wid) + "%"
        })
        $(slid[i]).addClass("grad-plus");
        
    }
}

function open_problem_modal(id, e){
    
    $.get("/problem",{problem_id: id},onAjaxSuccess);
    function onAjaxSuccess(data){
        data = JSON.parse(data);
        console.log(data);
        text = '';
        data.forEach(function(item, i) {
          text += '<p>' + (i+1) + '. ' + item.step_text + '</p>';
          text += '<div class="card-panel z-depth-0 grey lighten-2"><p>' + item.step_solve + '</p>';
          icon = '';
          button = false;
          text += '<div>';
          if (item.step_status === 'to_work'){
            text += '<a class="btn-floating waves-effect waves-light red tooltipped scale-transition" data-position="left" data-delay="50" data-tooltip="Add task to ToDoist" onclick="add_to_todoist(this,'+ item.step_id + ')"><i class="material-icons">add</i></a>';
          }
          else if (item.step_status === 'time'){
            text += '<i class="material-icons green-text">time</i>';
          }
          else if (item.step_status === 'done'){
            text += '<i class="material-icons">done</i>';
          }

          text += '</div></div>';
        });
        $('.modal-content').html(text);
        $("#modal1").modal("open");
        $('.tooltipped').tooltip({delay: 50});
    }
}
function add_to_todoist(e, id){
    text = e.parentElement.previousSibling.innerText;
    console.log(e.parentElement.previousSibling.innerText);
    $(e).addClass('scale-out');
    $.ajax({
          url: '/add_task',
          data: {text: text, id: id, step: 0}, // TODO: add step handling
          type: "GET",
          async: true,
          error: function(jqXHR, exception) {$(e).removeClass('scale-out');alert(jqXHR);}
    });
}
</script>
</html>
